/**
 * M6初始化引导区
 * Created by xiechunming on 2018/01/17.
 */

window.addEventListener('error', function (e) {
    if(typeof window.M6.getSysConfig != 'function'){
        alert(e.message);
    }else if(window.M6.getSysConfig('errorAlert', false)){
        alert(e.message);
    }
});

function addCss(cssUrls) {
    var style, headDom = document.getElementsByTagName('head')[0];
    for(var i = 0, length = cssUrls.length; i < length; i++){
        style = document.createElement('link');
        style.href = cssUrls[i];
        style.rel = 'stylesheet';
        style.type = 'text/css';
        headDom.appendChild(style);
    }
}

/**
 * 动态载入js
 * @param jsUrl
 * @param type js类型（url, text）
 * @param callback
 */
function addScript(jsUrl, type, callback){
    if(!jsUrl){
        callback && callback(jsUrl, false);
        return;
    }
    if(!type) type = 'url';
    var script = document.createElement('script');
    script.type = 'text/javascript';
    script.async = 'async';
    if(type === 'url'){
        script.src = jsUrl;
    }else{
        script.appendChild(document.createTextNode(jsUrl));
    }
    document.getElementsByTagName('head')[0].appendChild(script);
    script.addEventListener('error', function () {
        callback && callback(jsUrl, false);
    });
    script.addEventListener('load', function() {
        if (!this.readyState || this.readyState === "loaded" || this.readyState === "complete") {
            script.onload = script.onreadystatechange = null;
            callback && callback(jsUrl, true);
        }
    });
}

/** 环境检查 */
function nagvis(BCFG) {
    if(!window.localStorage){
        // 浏览器不支持H5 LocalStorage
        return undefined;
    }
    var jss = [], ua = navigator.userAgent.toLowerCase();
    if(ua.match(/MicroMessenger/i) == "micromessenger"){
        // 微信内核
    }else if(/(iPhone|iPad|iPod|iOS)/i.test(navigator.userAgent)){
        // 苹果设备
    }else if(/(Android)/i.test(navigator.userAgent)){
        // 安卓设备
        if(parseFloat(ua.split('android')[1].substring(1,4)) < 7)
            jss = jss.concat('./lib/polyfill.min.js'); // 添加全局污染兼容
    }
    var _loadBase = BCFG.env.env === 'production' || BCFG.env.operation === 'build';
    jss = jss.concat(_loadBase ? BCFG.basedOn : []).concat(BCFG.globalCDN).concat(_loadBase ? BCFG.dependOn : []);
    return jss;
}

function removeMask() {
    if(window.M6['onAppLoad'] && typeof window.M6['onAppLoad'] === 'function'){
        window.M6['onAppLoad'](_removeMask, _removeMask);
    }else{
        _removeMask();
    }
}
/** 移除遮罩 */
function _removeMask() {
    var countDown0 = setTimeout(function () {
        var maskDom = document.getElementById('M6BootInMask');
        if(maskDom){
            maskDom.setAttribute('class', maskDom.getAttribute('class') + ' m6-an-fade-out-slow');
            document.getElementById('root').removeAttribute('class');
            clearTimeout(countDown0);
        }
    }, 150);
    var countDown1 = setTimeout(function () {
        var maskDom = document.getElementById('M6BootInMask');
        if(maskDom){
            document.body.removeChild(maskDom);
            clearTimeout(countDown1);
        }
    }, 150 + 500);
}

function getBootConfig() {
    return JSON.parse(document.getElementById('M6BootInContent').innerText || '{}');
}

window.M6 = window.M6 || {};
window.onload = function () {
    // 环境检查
    window.M6.BCFG = window.M6.BCFG || getBootConfig();
    var jss = nagvis(window.M6.BCFG);
    if(jss === undefined) return;
    // 注入样式
    addCss(['./css/sprites.css', './css/basic.css'].concat(window.M6.BCFG.css));
    // 注入JS库
    var jsLength = jss.length, curIndex = 0, callback = function (jsUrl, status) {
        curIndex += 1;
        if(curIndex === jsLength){
            toEnd();
        }else{
            toProcess(curIndex, status);
        }
    }, toProcess = function (i, status) {
        addScript(jss[i], 'url', callback);
    }, toEnd = function () {
        removeMask();
    };

    if(jsLength > 0){
        toProcess(0);
    }else{
        toEnd();
    }
};